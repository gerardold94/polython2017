<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="components/balance-bar.html">
<link rel="import" href="components/user-info.html">
<link rel="import" href="components/badge.html">

<dom-module id="my-home">
  <template>
    <style include="shared-styles">
      :host {
        margin: 8px;
      }
      div {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      p {
        text-align: center;
        font-weight: 300;
      }

      p .hightlight {
        color: rgb(6, 117, 62);
        font-weight: bold;
      }
      
      balance-bar {
        flex: 0.7;
        --balance-bar-secondary-color: rgba(50, 150, 200, 0.8);
      }

      my-badge {
        margin: 1rem;
      }

      .badges {
        display: block;
        margin: 0 auto;
        padding: 1rem;
        width: 80%;
      }

      .main {
        display: block;
        text-align: center;
        background: white;
      }

      @media (max-width: 600px) {
        balance-bar {
          flex: 0.8;
        }
      }
    
    </style>
    <firebase-document
      id="query"
      path="/users/[[user.uid]]"
      data="{{userData}}">
    </firebase-document>

    <template is="dom-if" if="[[user]]">
      <user-info user="[[user]]" data ="[[userData]]"></user-info>
      <div>
        <balance-bar current-progress="[[amount]]" next-deposit="[[nextPay]]" goal="[[userData.goal]]"></balance-bar>
      </div>
      <p>
        Para llegar al alcance estimado tu próximo depósito debe ser de: 
        <span class="hightlight">$[[deposit]].00 MXN</span>
      </p>
      <div class="badges">
        <h3>Medallas</h3>
        <hr>
        <template is="dom-repeat" items="[[badges]]">
          <my-badge
            image="[[item.image]]"
            text="[[item.text]]"
            disabled="[[item.disabled]]">
          </my-badge>
        </template>
      </div>
    </template>

    <template is="dom-if" if="[[!user]]">
      <div class="main">
        <img src="http://opcionis.com/blog/wp-content/uploads/2016/09/bbva-logo-e1456838226318-750x300.png" alt="">
        <h1>Bienvenido</h1>
        <small>Por favor inicia sesión</small>
      </div>
    </template>
  </template>

  <script>
    class MyHomeView extends Polymer.Element {
      ready () {
        super.ready();
      }

      static get is() { return 'my-home'; }

      static get properties() {
        return {
          badges: {
            type: Object,
            value: Array
          },
          badges: {
            type: Object,
            value: Array
          },
          user: {
            type: Object,
            value: false
          },
          userData: {
            type: Object,
            observer: 'dataChanged'
          },
          payments: {
            type: Object,
            value: Array,
            notify: true
          },
          nextPay: {
            type: Number,
            value: 0,
            notify: true
          },
          amount: {
            type: Number,
            value: 0
          },
          uid: String,
          deposit: Number
        };
      }

      _nextDeposit(amount) {
        let sum = 0;
        let count = 0;
        if (!this.payments) return 0;
        this.payments.forEach(pay => {
          sum += pay.amount;
          count++;
        });
        return this.amount + (sum / count);
      }

      _currentAmount() {
        let sum = 0;
        if (!this.payments) return 0;
        this.payments.forEach(pay => {
          sum += pay.amount;
        });
        return sum;
      }

      dataChanged (newData, oldData) {
        this.badges = [];
        this.payments = [];
        console.log(newData);
        if (!newData || !newData.goal) return;
        if (newData.badges) {
          newData.badges.forEach(element => {
            this.badges.push(element);
          });
        }
        if (newData.payments) {
          newData.payments.forEach(element => {
            this.payments.push(element);
          });
          this.nextPay = this._nextDeposit(newData.amount);
          this.amount = this._currentAmount();
          this.deposit = this.nextPay - this.amount;
        }
      }
    }
    window.customElements.define(MyHomeView.is, MyHomeView);
  </script>
</dom-module>